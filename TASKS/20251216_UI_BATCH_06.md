# SPLENTA UI Batch 06: Custom Controls (Waveform & Split-Toggle)

你是 JUCE 自定义控件开发专家。Batch 05 系列已经统一了视觉风格，Batch 06 的目标是替换掉所有原生的、丑陋的 JUCE 控件（ComboBox, ToggleButton），替换为完全自定义绘制的图形化控件。

---

## 任务 1：自定义波形选择器 (Waveform Tray)

**目标**：替换 "Generator" 面板中的波形选择 ComboBox。
**设计**：
- **外观**：三个连在一起的圆角矩形（托盘状），类似于 Segmented Control。
- **内容**：不显示文字，而是绘制图形图标（Sine, Triangle, Square）。
- **颜色**：
  - 选中项：高亮显示。
  - **色系要求**：三个选项使用主题 Accent Color 的“邻近色” (Analogous Colors)。例如，如果主题是蓝色，三个按钮分别是 青蓝、正蓝、深蓝。可以使用 `colour.withRotatedHue(float)` 来生成。
- **交互**：点击对应区域切换参数。

**技术实现建议**：
- 创建新组件 `WaveformSelectorComponent`。
- 成员变量：`Attachment` (连接到波形选择参数)。
- `paint` 方法：使用 `juce::Path` 绘制正弦线、三角形轮廓、正方形轮廓。

---

## 任务 2：斜切双控开关 (Split Dual Toggle)

**目标**：将 "Auto Gain" 和 "Soft Clip" 两个开关合并为一个紧凑的方形控件，并移动到 "Master Output" 面板内。
**设计**：
- **外观**：一个正方形，中间有一条从**左下角到右上角**（或左上到右下，根据用户要求：左上半部 AutoGain，右下半部 SoftClip）的斜线，将方块一分为二。
- **状态颜色**：
  - **左上三角形 (Auto Gain)**：激活时填充 Theme Color A，未激活暗淡。
  - **右下三角形 (Soft Clip)**：激活时填充 Theme Color B (稍微错开一点色相)，未激活暗淡。
- **交互**：
  - 点击左上区域 -> 切换 Auto Gain。
  - 点击右下区域 -> 切换 Soft Clip。
  - 需要在 `mouseDown` 中进行坐标几何判定（`y < x` 或类似逻辑，取决于斜线方向）。

**技术实现建议**：
- 创建新组件 `SplitToggleComponent`。
- 成员变量：两个 `Attachment` (分别对应 AutoGain 和 SoftClip 参数)。
- `paint`：使用 `g.reduceClipRegion` 或 `Path` 来分别填充两个三角形区域。

---

## 任务 3：仿 Web 版预设顶栏 (Web-Style Header)

**目标**：重构插件顶部的 Header 区域，使其与 Web 版一致。
**设计**：
- 移除：旧的 `juce::ComboBox` 预设选择器。
- 新增：
  - 左侧：[LOGO ICON] **SPLENTA** (Title)
  - 中间/右侧：[SAVE] [LOAD] [Preset Name Display]
  - 样式：纯文字按钮（TextButton 设为无边框），鼠标悬停高亮。字体使用 JetBrains Mono。

---

## 任务 4：全局字体与排版

**目标**：引入 JetBrains Mono 字体。
**执行**：
- 检查资源中是否有 `JetBrainsMono-Regular.ttf`。如果没有，请尝试使用 LookAndFeel 的 `setDefaultFont` 设置为系统等宽字体作为回退，或者提示用户添加资源。
- 将所有 Label、Button、Knob Value 的字体设置为该字体。

---

## 布局调整
- 将新的 `SplitToggleComponent` 放置在 "MASTER OUTPUT" 面板的空闲区域（原 AutoGain/SoftClip 的位置）。
- 确保所有新控件都正确绑定了 APVTS 参数。

## 检查清单
- [x] Generator 面板现在是否显示为三个图形化的波形按钮？
- [x] Master Output 面板是否有一个斜切的方形双开关？
- [x] 点击斜切开关的左上和右下是否能分别控制两个参数？
- [ ] 顶部 Header 是否变成了 Web 版那种简洁的文字按钮样式？（未实现）
- [ ] JetBrains Mono 字体集成（未实现）

---

## 实施记录 (20251216)

### 任务 1：WaveformSelectorComponent - 滑动开关设计 ✅

**初始设计问题**：
- 使用了点击式三段按钮设计，但遇到严重的点击检测问题
- 图标绘制区域过小（`reduced(12.0f)`），导致点击区域不准确
- 第三个按钮（Square）始终无法点击

**根本原因发现**：
- SHAPE 参数是 `AudioParameterChoice`，值范围是 **0-2** (0=Sine, 1=Triangle, 2=Square)
- 错误地在代码中使用了 `+1` 转换，导致发送值变成 1-3
- 当点击第三个选项时，发送值3超出参数范围，导致无效

**最终解决方案 - 滑动开关交互**：
```cpp
// 设计改为类似硬件滑动开关的交互方式
class WaveformSelectorComponent : public juce::Component, public juce::Timer
{
    // 视觉层次：
    // 1. 底层：三个色块（sine/triangle/square）始终显示，半透明
    // 2. 滑动层：高亮指示器平滑滑动到当前选中位置（带动画）
    // 3. 图标层：三个波形图标，选中的更亮

    // 交互方式：
    // - mouseDown：点击任意位置立即切换
    // - mouseDrag：左右拖动，实时切换（像硬件开关）
    // - 60fps timer：平滑动画插值
};
```

**关键代码修复**：
```cpp
// 错误的参数转换（导致Square无法选中）
param->convertTo0to1((float)(clickedIndex + 1));  // ✗ 发送 1,2,3

// 正确的参数转换
param->convertTo0to1((float)clickedIndex);  // ✓ 发送 0,1,2
```

**技术实现**：
- 使用 `juce::Timer` 实现 60fps 平滑动画
- `sliderPosition` 变量存储动画位置（0.0-1.0），通过插值平滑移动
- 邻近色生成：`palette.accent.withRotatedHue(±0.05f)`
- 组件 z-order：使用 `setAlwaysOnTop(true)` 确保不被 slider 遮挡

**文件**：
- `Source/WaveformSelectorComponent.h`
- `Source/WaveformSelectorComponent.cpp`

---

### 任务 2：SplitToggleComponent - 斜切双开关 ✅

**设计要求**：
- 对角线分割的方形控件，左上=Auto Gain，右下=Soft Clip
- 点击检测使用几何判定（`y < h - (h/w) * x`）

**初始实现问题**：
- 位置多次与其他控件重叠
- 视觉风格不统一（尖角、颜色过于鲜艳）
- 文字标签 "AGM" 和 "CLIP" 字体过小

**最终优化**：
```cpp
// 视觉优化
const float cornerRadius = 6.0f;  // 圆角匹配整体UI
juce::Colour colorA = palette.accent.withRotatedHue(-0.03f);  // 减小色相偏移
juce::Colour colorB = palette.accent.withRotatedHue(0.03f);
// 填充透明度从 0.4f 降低到 0.2f，更柔和

// 使用 Path clipping 实现圆角三角形
g.saveState();
g.reduceClipRegion(clipPath);  // clipPath 是圆角矩形
g.fillPath(topTriangle);       // 填充三角形
g.restoreState();

// 标签改为大字母
g.setFont(juce::FontOptions(28.0f, juce::Font::bold));
g.drawText("A", ...);  // Auto Gain
g.drawText("C", ...);  // Soft Clip
```

**布局定位**：
- 最终位置：`(850, 290, 75×75)` - Output 面板右上角空白区域
- 避免与旋钮（最右820px）和标签（Y=595）重叠

**文件**：
- `Source/SplitToggleComponent.h`
- `Source/SplitToggleComponent.cpp`

---

### 任务 3 & 4：Web-Style Header 与 JetBrains Mono 字体 ⏸️

**状态**：暂未实施
**原因**：优先解决 Batch 06 核心交互问题

---

### 集成与调试

**PluginEditor 集成**：
```cpp
// 构造函数 - 在 slider 之前添加自定义组件，确保 z-order
addAndMakeVisible(waveformSelector);
waveformSelector.setAlwaysOnTop(true);
addAndMakeVisible(splitToggle);
splitToggle.setAlwaysOnTop(true);

// setupKnob(...) 调用在后面

// resized() 布局
waveformSelector.setBounds(20 + colW, startY + gap*2, 150, 28);  // (240, 474, 150×28)
splitToggle.setBounds(850, startY, 75, 75);  // (850, 290, 75×75)
```

**主题集成**：
```cpp
// updateColors() 中添加
waveformSelector.setPalette(palette);
splitToggle.setPalette(palette);
```

**NewProject.jucer 注册**：
已添加文件：
- WaveformSelectorComponent.cpp (compile=1)
- WaveformSelectorComponent.h (compile=0)
- SplitToggleComponent.cpp (compile=1)
- SplitToggleComponent.h (compile=0)

---

### 遇到的关键问题与解决

#### 问题 1: WaveformSelector 第三个按钮无法点击
**症状**：前两个按钮（Sine/Triangle）可以切换，Square 始终无效
**诊断**：
```cpp
// PluginProcessor.cpp:421
layout.add(std::make_unique<juce::AudioParameterChoice>(
    juce::ParameterID("SHAPE", 1), "Shape",
    juce::StringArray("Sine", "Triangle", "Square"),
    0  // 默认值 0
));
// AudioParameterChoice 的值范围是 [0, numChoices-1]，即 0-2
```
**错误代码**：
```cpp
// WaveformSelectorComponent.cpp - 错误版本
selectedIndex = juce::roundToInt(param->load()) - 1;  // 0→-1, 1→0, 2→1
param->convertTo0to1((float)(clickedIndex + 1));      // 0→1, 1→2, 2→3 (越界!)
```
**修复**：
```cpp
// 正确版本 - 直接使用 0-2
selectedIndex = juce::jlimit(0, 2, juce::roundToInt(param->load()));
param->convertTo0to1((float)clickedIndex);
```

#### 问题 2: 点击检测失效
**尝试的方法**：
1. `event.position.x` → 无效
2. `event.getMouseDownPosition()` → 无效
3. `event.getPosition()` → 无效
4. 添加 `mouseUp` 事件 → 无效
5. 调整图标区域 `reduced()` 参数 → 无效

**根本原因**：参数值转换错误（见问题1），与点击检测代码无关

**最终解决**：改为滑动开关交互，整个组件区域响应鼠标，避免复杂的点击区域判定

#### 问题 3: SplitToggle 视觉不一致
**问题**：尖角矩形、过亮的颜色与圆角柔和的整体UI不协调
**解决**：
- 圆角 6px（与 WaveformSelector 一致）
- 色相偏移从 ±0.08f 降至 ±0.03f
- 填充 alpha 从 0.4f 降至 0.2f
- 使用 `g.reduceClipRegion()` 实现圆角三角形

---

### 版本更新

**文件头版本**：`SPLENTA V18.6 - 20251216.09`
**涉及文件**：
- PluginEditor.cpp / PluginEditor.h
- WaveformSelectorComponent.cpp / WaveformSelectorComponent.h (新建)
- SplitToggleComponent.cpp / SplitToggleComponent.h (新建)

---

### 待完成事项
- [ ] 任务 3：Web-Style Header（SAVE/LOAD 按钮，预设名称显示）
- [ ] 任务 4：JetBrains Mono 字体集成
- [ ] 优化：WaveformSelector 动画曲线（当前线性插值，可改为 ease-out）
